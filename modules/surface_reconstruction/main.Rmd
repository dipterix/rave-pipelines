---
title: "RAVE Pipeline - Surface Reconstruction & CT Co-Registration"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
# This code block sets up the engine environment
# Please do not remove me
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
build_pipeline <- raveio::configure_knitr()
if(FALSE) {
  settings <- raveio::load_yaml(file.path(rstudioapi::getActiveProject(), "modules", 
                                     "surface_reconstruction", "settings.yaml"))
  invisible(list2env(as.list(local({
    print(names(settings))
    settings
  })), envir = environment()))
}
```

```{rave check_commandline_tools, language = "R", export = "cmd_tools", cue = "always"}

dry_run <- raveio::is_dry_run()

dcm2niix <- tryCatch({
  dcm2niix <- raveio::normalize_commandline_path(
    path = dcm2niix_path, 
    unset = raveio:::cmd_dcm2niix(error_on_missing = FALSE)
  )
  if(!isTRUE(file.exists(dcm2niix))) { dcm2niix <- NULL }
  dcm2niix
}, error = function(e){ NULL })

freesurfer <- tryCatch({
  freesurfer <- raveio::normalize_commandline_path(
    path = freesurfer_path, 
    unset = raveio:::cmd_freesurfer_home(error_on_missing = FALSE)
  )
  if(!isTRUE(dir.exists(freesurfer))) { freesurfer <- NULL }
  freesurfer
}, error = function(e){ NULL })


flirt <- tryCatch({
  flirt <- raveio::normalize_commandline_path(
    path = flirt_path, 
    unset = raveio:::cmd_fsl_flirt(error_on_missing = FALSE)
  )
  if(!isTRUE(dir.exists(flirt))) { flirt <- NULL }
  flirt
}, error = function(e){ NULL })

cmd_tools <- list(
  dry_run = dry_run,
  dcm2niix = dcm2niix,
  freesurfer = freesurfer,
  flirt = flirt
)
```

```{rave load_subject, language = "R", export = "subject"}

subject <- raveio::RAVESubject$new(
  project_name = project_name, 
  subject_code = subject_code,
  strict = FALSE
)
print(subject)
```

```{rave check_subject_data, export = "check_result", cue = "always"}

msgs <- character(0L)
warns <- character(0L)

fs_path <- subject$freesurfer_path
if(!length(fs_path) || is.na(fs_path) || !isTRUE(dir.exists(fs_path))) {
  fs_path <- file.path(subject$path, "fs")
  fs_reconstructed <- FALSE
} else {
  fs_reconstructed <- threeBrain::check_freesurfer_path(
    fs_path,
    autoinstall_template = FALSE,
    check_volume = TRUE,
    check_surface = FALSE
  )
}


mri <- NULL
if(!skip_recon) {
  if(is.null(cmd_tools$dcm2niix) || is.null(cmd_tools$freesurfer)) {
    warns <- append(warns, "Cannot find command-line `dcm2niix` and/or `FreeSurfer`: the reconstruction will be skipped")
    skip_recon <- TRUE
  } else {
    mri <- file.path(subject$preprocess_settings$raw_path, path_mri)
    if(!isTRUE(dir.exists(mri))) {
      warns <- append(warns, "No MRI folder found, the reconstruction will be skipped")
      skip_recon <- TRUE
    }
  }
  if(!skip_recon && fs_reconstructed) {
    warns <- append(warns, sprintf("Found existing FreeSurfer reconstructed directory; this directory will be renamed: %s", fs_path))
  }
}

ct <- NULL
if(!skip_coregistration) {
  if(is.null(cmd_tools$flirt)) {
    warns <- append(warns, "Cannot find FSL-flirt; the co-registration will be skipped")
    skip_coregistration <- TRUE
  } else if( (!fs_reconstructed && (is.null(cmd_tools$dcm2niix) || is.null(cmd_tools$freesurfer))) ) {
    warns <- append(warns, "Cannot find FreeSurfer reconstruction, nor at least one of the following commands exists: `dcm2niix`, `FreeSurfer`. The co-registration will be skipped anyway")
    skip_coregistration <- TRUE
  } else {
    ct <- file.path(subject$preprocess_settings$raw_path, path_ct)
    if(!isTRUE(dir.exists(ct))) {
      warns <- append(warns, "No CT folder found, the co-registration will be skipped")
      skip_coregistration <- TRUE
    }
  }
}

if(!skip_recon) {
  msgs <- append(msgs, sprintf("New FreeSurfer reconstruction will be created from %s", mri))
  msgs <- append(msgs, sprintf("MRI default folder will be set: %s", path_mri))
}
if(!skip_coregistration) {
  msgs <- append(msgs, sprintf("CT will be co-registered to MRI for electrode localization; CT path: %s", ct))
  msgs <- append(msgs, sprintf("CT default folder will be set: %s", path_ct))
}

check_result <- list(
  project_name = subject$project_name,
  subject_code = subject$subject_code,
  fs_path = fs_path,
  
  fs_reconstructed = fs_reconstructed,
  skip_recon = skip_recon,
  skip_coregistration = skip_coregistration,
  
  has_dcm2niix = !is.null(cmd_tools$dcm2niix),
  has_freesurfer = !is.null(cmd_tools$freesurfer),
  has_flirt = !is.null(cmd_tools$flirt),
  
  path_mri = mri,
  path_ct = ct,
  
  messages = msgs,
  warnings = warns
)


```

```{rave set_default_paths, export = "default_paths", cue = "always"}

if(!check_result$skip_recon && isTRUE(dir.exists(check_result$path_mri))) {
  ravedash::logger("Setting default MRI folder: ", path_mri, level = "info")
  subject$set_default("raw_mri_path", path_mri, namespace = "surface_reconstruction")
}

if(!check_result$skip_coregistration && isTRUE(dir.exists(check_result$path_ct))) {
  ravedash::logger("Setting default CT folder: ", path_ct, level = "info")
  subject$set_default("raw_ct_path", path_ct, namespace = "surface_reconstruction")
}

default_paths <- subject$get_default(c("raw_mri_path", "raw_ct_path"), namespace = "surface_reconstruction")
default_paths
```

## Build, Visualize, & Run

Please make sure the following code block is at the end of your pipeline file. This block will build the pipeline and generate a `make-surface_reconstruction.R` script with your pipeline markdown file. `RAVE` will use the generated pipeline script to execute the pipeline in the dashboard application, or in massive production mode.

```{r build, echo=FALSE, results='hide'}
build_pipeline(make_file = "make-surface_reconstruction.R")
```


Once the pipeline script `make-surface_reconstruction.R` is built, you can visualize and execute the pipeline without the need of re-knit this document. Notice we use `r` block instead of `rave`. (This is because the code blocks are not part of pipeline targets.)

```{r visualize, echo=FALSE}
Sys.setenv("RAVE_PIPELINE" = normalizePath("."))
raveio::pipeline_visualize()
```







---
title: "RAVE Pipeline Markdown Template"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
# This code block sets up the engine environment
# Please do not remove me
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
build_pipeline <- raveio::configure_knitr()
# build_pipeline(make_file = "make-power_explorer.R")
```

```{rave create_subject_instance, language = "R", export = "subject"}
# raveio::pipeline_debug(quick = FALSE)
library(raveio)
subject_id <- sprintf("%s/%s", project_name, subject_code)
subject <- as_rave_subject(subject_id, strict = TRUE)
subject
```

1. Check inputs

```{rave check_load_epoch, language = "R", export = "epoch"}
# ---- Check epoch file ----
epoch <- subject$get_epoch(epoch_name = epoch_name, 
                           trial_starts = trial_starts)
```

```{rave check_load_reference, language = "R", export = "reference_table"}
# ---- Check reference file ----
reference_table <- subject$get_reference(
  reference_name = reference_name)
```

```{rave check_load_electrodes, language = "R", export = "electrode_table"}
# ---- Check electrodes ----
electrode_table <- subject$get_electrode_table(
  electrodes = loaded_electrodes, 
  reference_name = reference_name)
```

```{rave load_frequencies, language = "R", export = "frequency_table"}
frequency_table <- subject$get_frequency(simplify = FALSE)
```

2. Load data

```{rave get_electrode_list, language = "R", export = "electrode_list"}
loading <- subset(electrode_table, subset = electrode_table$isLoaded)
electrode_list <- unique(loading$Electrode)
```

```{rave get_references_list, language = "R", export = "references_list"}
ref_table <- subset(reference_table, Electrode %in% electrode_list)
references_list <- unique(ref_table$Reference)
```

```{rave load_references, language = "R", export = "reference_data", cue = "always", pattern = "map(references_list)"}
# load reference first, do not create race conditions
ref_name <- references_list[[1]]
ref <- raveio::LFP_electrode$new(subject = subject, ref_name, is_reference = TRUE)
ref$set_epoch(epoch)
ref$trial_intervals <- list(c(trial_starts, trial_ends))
reference_data <- ref$load_data(type = "power")
```

```{rave load_electrode_power, language = "R", export = "power_list", cue = "always", pattern = "map(electrode_list)"}
force(reference_data)
e <- electrode_list[[1]]
# Load electrodes
ref_name <- reference_table$Reference[reference_table$Electrode == e]
el <- raveio::LFP_electrode$new(subject = subject, e, is_reference = FALSE)
ref <- raveio::LFP_electrode$new(subject = subject, ref_name, is_reference = TRUE)
el$set_reference(ref)
el$set_epoch(epoch)
el$trial_intervals <- list(c(trial_starts, trial_ends))
power_list <- el$load_data(type = "power")

```

```{rave load_dimension_names, language = "R", export = "power_dimnames"}
if(is.list(power_list)){
  tmp <- power_list[[1]]
} else {
  tmp <- power_list
}
power_dimnames <- dimnames(tmp)
power_dimnames$Electrode <- electrode_table$Electrode[electrode_table$isLoaded]
```

## Build, Visualize, & Run

Please make sure the following code block is at the end of your pipeline file. This block will build the pipeline and generate a `make-power_explorer.R` script with your pipeline markdown file. `RAVE` will use the generated pipeline script to execute the pipeline in the dashboard application, or in massive production mode.

```{r build, echo=FALSE, results='hide'}
build_pipeline(make_file = "make-power_explorer.R")
```


Once the pipeline script `make-power_explorer.R` is built, you can visualize and execute the pipeline without the need of re-knit this document. Notice we use `r` block instead of `rave`. (This is because the code blocks are not part of pipeline targets.)

```{r visualize, echo=FALSE}
Sys.setenv("RAVE_PIPELINE" = normalizePath("."))
raveio::pipeline_visualize()
```


```{r execute}
Sys.setenv("RAVE_PIPELINE" = normalizePath("."))
raveio::pipeline_run(type = "vanilla")
raveio::pipeline_progress(method = 'details')
```






